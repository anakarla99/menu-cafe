<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Menú Enlace</title>
    <meta charset="utf-8" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://use.typekit.net/fmq1kkq.css">
    <link rel="stylesheet" href="styles/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">

    <!-- Agregar estas bibliotecas para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Estilos para la impresión automática -->
    <style>
        /* Estilos específicos para impresión */
        @media print {
            /* Ocultar todos los elementos normales */
            
            body > *:not(#printContainer) {
                display: none !important;
            }@page {
                size: A4;
                margin: 10;
                background: rgb(237, 238, 245) !important;
            }
            html, body {
                background: rgb(237, 238, 245) !important;
            }
            #printContainer {
                display: block !important;
                background: rgb(237, 238, 245)!important;
            }
            /* Hacer que el footer se repita al final de cada página */
            .print-content {
                position: relative;
                min-height: 100vh;
            }
            /* Eliminar footer y disclaimer de la portada */
            .print-cover + .price-disclaimer-container,
            .print-cover + .footer {
                display: none !important;
            }
            /* Posicionar el disclaimer encima del footer en todas las páginas */
            .price-disclaimer-container {
                position: fixed;
                bottom: 100px; /* Posicionado encima del footer */
                left: 0;
                width: 100%;
                text-align: center;
                page-break-inside: avoid;
                break-inside: avoid;
                display: block !important;
                padding: 0 10mm;
                box-sizing: border-box;
                z-index: 100;
                font-style: italic;
                font-size: 11px;
                color: #666;
            }
            .footer {
                position: fixed;
                bottom: 15px;
                left: 0;
                width: 100%;
                height: 50px;
                page-break-inside: avoid;
                break-inside: avoid;
                display: flex !important;
                align-items: center;
                justify-content: center;
                background-image: url('styles/img/pattern2.svg') !important;
                background-size: cover !important;
                background-color: rgb(237, 238, 245) !important;
            }
            .print-menu-area {
                column-count: 2;
                column-gap: 10mm;
                /* Opcional: para evitar que una categoría se parta entre columnas */
                break-inside: avoid;
                /* Asegura que las categorías no se corten entre columnas */
                page-break-inside: avoid;
                marginBottom: 70px;
            }
            .print-category {
                margin-bottom: 5mm;
                /* Opcional: agrega espacio entre categorías */
            }
            .print-content .footer,
            .print-cover,
            .price-disclaimer-container {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            .print-content > .header {
                break-after: avoid-page;
                page-break-after: avoid;
            }
            /* Si agrupas header y menú: */
            .print-header-group {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            /* Centrar portada */
            .print-cover {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 90vh;
                page-break-after: always;
            }
            .print-cover__image {
                max-width: 60vw;

                max-height: 60vh;
                margin: auto;
                display: block;
            }
            
            /* Centrar los items del menú */
            .print-content .menu-list-item {
                display: block !important;
                text-align: left !important;
                justify-content: initial !important;
                align-items: initial !important;
                flex-direction: initial !important;
                margin-left: 10mm;
                margin-right: 10mm;
                margin-top: 2mm;
                margin-bottom: 2mm;
                page-break-inside: avoid;
                break-inside: avoid;
                position: relative;
            }
            /* Ajustar el margen inferior del contenido principal para evitar superposición */
            .all-categories {
                margin-bottom: 80px; /* Debe ser mayor que la altura del footer */
            }
        
            .print-content .menu-list-item .header-item {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: flex-end !important;
                width: 100%;
                text-align: left;
                gap: 2em;
            }
            .print-content .menu-list-item__title {
                flex-grow: 1;
                margin: 0;
                padding-right: 20px; /* Aumentado de 10px a 15px */
                max-width: 80%; /* Aumentado de 70% a 75% */
                min-width: 60%; /* Añadido ancho mínimo */
                white-space: nowrap;
            }
            .print-content .menu-list-item__dots {
                flex: 1 1 auto;
                height: 1em;
                margin: 0 1em;
                min-width: 1em;
                max-width: 50px;
                flex-grow: 1;
            }
            /* Precio alineado a la derecha */
            .print-content .menu-list-item__price {
                flex-shrink: 0;
                text-align: right;
                min-width: 30px; /* Ancho fijo para alinear precios */
            }
            .print-content .menu-list-item__desc,
            .print-content .menu-list-item__dots,
            .print-content .menu-list-item__price {
                display: inline-block !important;
                margin: 0 !important;
                text-align: left !important;
                min-width: 0;
                white-space: pre-line;
            }
            .title-line {
                display: inline-block;
                flex-grow: 1;
                height: 2px;
                background-color: rgba(17, 30, 108);
                margin: 0 1rem;
                position: relative;
                min-width: 40px;
            }

            .title-line::after {
                display: inline-block;
                content: '';
                position: absolute;
                top: 4px;
                /* Espacio entre las dos líneas */
                left: 0;
                right: 0;
                height: 4px;
                /* Línea inferior más gruesa */
                background-color: rgba(17, 30, 108);
            }
            .header {
                background-image: url('styles/img/pattern2.svg') !important;
                background-size: cover !important;
                background-color: rgb(237, 238, 245) !important;
            }
            /* Forzar que los títulos se muestren al inicio de cada página cuando hay división */
            .print-category > .menu-title-container {
                break-before: auto;
                page-break-before: auto;
            }

            /* Si una categoría comienza cerca del final de la página, 
               moverla a la siguiente página para evitar un título suelto */
            .print-category {
                page-break-inside: avoid;
            }

            /* Asegurar que no queden viudas (líneas sueltas al final de página) */
            .menu-items {
                orphans: 3;
                widows: 3;
            }
            
        }

        /* Estilo para ocultar la versión imprimible */
        .print-version {
            display: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header__container">
            <button class="menu-toggle" aria-label="Abrir menú">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1 class="header__title">Menú Enlace</h1>
        </div>
    </header>

    <section class="menu layout">
        <aside class="menu-sidebar">
            <ul class="menu-nav"></ul>
        </aside>
        <main class="menu-content">
            <div class="menu-title-container">
                <div class="title-line left-line"></div>
                <h2 class="menu-title"></h2>
                <div class="title-line right-line"></div>
            </div>
            <div class="menu-items"></div>
        </main>
    </section>

    <!-- Texto de advertencia de precios encima del footer -->
    <div class="price-disclaimer-container">
        <p class="price-disclaimer">Los precios pueden ajustarse según la variación en el costo de materias primas</p>
    </div>

    <footer class="footer">
        <div class="footer__container"> 
            <img src="styles/img/id2try.svg" alt="Identidad" class="footer__image">
        </div>
    </footer>

    <!-- Contenedor oculto para el contenido completo de impresión -->
    <div class="print-container" id="printContainer">
        <!-- Aquí se clonará todo el contenido cuando sea necesario -->
    </div>

    <!--JS Files-->
    <script src="js-menu/jquery-3.7.1.min.js"></script>
    <script src="js-menu/menu.js"></script>

    <!-- Script para manejar la impresión automática -->
    <script>
        // Esperar a que se carguen las bibliotecas
        window.jsPDF = window.jspdf.jsPDF;
        
        
        // Función para obtener datos del menú desde menu.js
        function getMenuData() {
            if (typeof window.getMenuDataForPrint === 'function') {
                return window.getMenuDataForPrint();
            }
            return {};
        }
        
        // Función para preparar el contenido de impresión
        function preparePrintContent() {
            const printContainer = document.getElementById('printContainer');
            printContainer.innerHTML = '';
            
            // Obtener datos del menú
            const menuData = getMenuData();
            
            // Verificar si hay datos
            if (Object.keys(menuData).length === 0) {
                printContainer.innerHTML = '<div class="print-content"><p>No hay datos del menú disponibles. Por favor, espere a que se cargue el menú.</p></div>';
                return;
            }
            
            // Crear contenedor principal
            const printContent = document.createElement('div');
            printContent.className = 'print-content';

             // --- NUEVO: Imagen centrada en la primera página ---
            const portada = document.createElement('div');
            portada.className = 'print-cover';
            portada.innerHTML = `
                <img src="styles/img/id2try.svg" alt="Identidad" class="print-cover__image">
            `;
            printContent.appendChild(portada);
            
            //// Clonar el encabezado
            //const headerClone = document.querySelector('.header').cloneNode(true);
            //// Limpiar estilos que podrían interferir
            //const menuToggle = headerClone.querySelector('.menu-toggle');
            //if (menuToggle) menuToggle.remove();
            //printContent.appendChild(headerClone);

            
            // Crear contenedor para todas las categorías
            const allCategoriesContainer = document.createElement('div');
            allCategoriesContainer.className = 'all-categories print-menu-area';
            
            // Obtener todas las categorías
            const categories = Object.keys(menuData);
            
            // Generar HTML para cada categoría
            categories.forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'menu-category print-category';
                
                // Título de la categoría
                const titleContainer = document.createElement('div');
                titleContainer.className = 'menu-title-container';

                const leftLine = document.createElement('div');
                leftLine.className = 'title-line left-line';

                const title = document.createElement('h2');
                title.className = 'menu-title';
                title.textContent = category;

                const rightLine = document.createElement('div');
                rightLine.className = 'title-line right-line';

                titleContainer.appendChild(leftLine);
                titleContainer.appendChild(title);
                titleContainer.appendChild(rightLine);

                categorySection.appendChild(titleContainer);

                // Items de la categoría
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'menu-items';
                
                // Agregar cada item
                //<div class="content">
                            //    <span class="menu-list-item__desc">${item.desc || ''}</span>
                            //    <span class="menu-list-item__dots"></span>
                            //    <span class="menu-list-item__price">${item.price ? item.price + ' CUP' : ''}</span>
                            //</div>
                menuData[category].forEach(item => {
                    const itemHTML = `
                        <div class="menu-list-item">
                            <div class="header-item">
                                <h4 class="menu-list-item__title">${item.title || ''}</h4>
                                <span class="menu-list-item__price">${item.price ? item.price + ' CUP' : ''}</span>
                            </div>
                        </div>
                    `;
                    itemsContainer.innerHTML += itemHTML;
                });
                
                categorySection.appendChild(itemsContainer);
                allCategoriesContainer.appendChild(categorySection);
            });
            
            printContent.appendChild(allCategoriesContainer);


            //const headerGroup = document.createElement('div');
            //headerGroup.className = 'print-header-group';
            //headerGroup.appendChild(headerClone);
            //headerGroup.appendChild(allCategoriesContainer);
            //printContent.appendChild(headerGroup);
            
            // Clonar el disclaimer de precios
            const disclaimerClone = document.querySelector('.price-disclaimer-container').cloneNode(true);
            printContent.appendChild(disclaimerClone);
            
            // Clonar el footer
            const footerClone = document.querySelector('.footer').cloneNode(true);
            printContent.appendChild(footerClone);
            
            printContainer.appendChild(printContent);
        }
        
        // Función para generar PDF
        function generatePDF() {
            // Obtener datos del menú
            const menuData = getMenuData();
            
            // Verificar si los datos están cargados
            if (Object.keys(menuData).length === 0) {
                alert('El menú aún se está cargando. Por favor, espere un momento y vuelva a intentarlo.');
                return;
            }
            
            preparePrintContent();
            
            const element = document.getElementById('printContainer');
            
            // Pequeña pausa para asegurar que el DOM se actualizó
            setTimeout(() => {
                html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 297;

                    // Márgenes en mm
                    const marginTop = 20;
                    const marginBottom = 20;
                    const usableHeight = pageHeight - marginTop - marginBottom;

                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= usableHeight;
                    
                    // Añadir páginas adicionales si el contenido es muy largo
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        position = marginTop - (imgHeight - heightLeft)
                        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                        heightLeft -= usableHeight;
                    }
                    
                    // Descargar el PDF
                    //pdf.save('menu-enlace-completo.pdf');
                    
                    // Limpiar el contenedor de impresión
                    element.innerHTML = '';
                }).catch(error => {
                    console.error("Error generating PDF:", error);
                    alert('Error al generar el PDF. Por favor, intente nuevamente.');
                });
            }, 100);
        }
        
        window.onbeforeprint = function() {
            preparePrintContent();
        };
        window.onafterprint = function() {
            document.getElementById('printContainer').innerHTML = '';
        };
        // Manejar la impresión con Ctrl+P
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                //generatePDF();
                const menuData = getMenuData();
            
                // Verificar si los datos están cargados
                if (Object.keys(menuData).length === 0) {
                    alert('El menú aún se está cargando. Por favor, espere un momento y vuelva a intentarlo.');
                    return;
                }

                preparePrintContent();

                // Espera un poco para que el DOM se actualice antes de imprimir
                setTimeout(() => {
                    window.print();
                }, 100);
            }
        });
    </script>
</body>
</html>

